# Exploiting Active Directory

## Exploiting Permission Delegation

**Permission Delegations** represents one of the mai features of AD which makes it so popular in an organisation environment. This feature translates to the ability to temporarily delegate a special permission to a user that doesn't have the permission by default (such as an admin user delegating the permission to change a user's password to the helpdesk team.)

Permission delegations can be exploited due to misconfiguration (most commonly because they do not follow the principle of least privilege).

AD Administrators can configure Access Control Entries (ACEs) that populate Discretionary Access Control Lists (DACLs). This is why permission delegation exploits are commonly referred to as ACL-based attacks.

Most commonly misconfigured ACEs:

* ForceChangePassword
* AddMembers
* GenericAll
* GenericWrite
* WriteOwner
* WriteDACL
* AllExtendedRights

Interacting with misconfigured ACEs is best done using `AD-RSAT` PowerShell cmdlets or using `PowerSploit`.

## Exploiting Kerberos Delegation

Kerberos Delegation refers to an application being able to access resources hosted on a different server. It is the alternative to using a service account and providing it with direct access to the database.

Kerberos Delegation can be either **constrained** (restricts what services an account can be delegated to) or **unconstrained** (least secure, has no limits to the delegation). A third type of Kerberos delegation can be **Resource-based constrained** delegation, which provides additional restrictions (the service specifies which objects can delegate to it).

Constrained Delegation can be exploited by impersonating users that have permission to delegate (using `Mimikatz` to dump the secrets from the registry hive, and then performing a Kerberos delegation attack using `Kekeo`, by forging TGS requests for the TGT account that can perform the delegation).

## Exploiting Automated Relays

Since Windows computer utilize machine accounts to perform tasks such as synchronising AD updates and changes, this means that there are many authentication attempts flying across the network.

This means the first step would be to identify which AD machine account has admin rights over another machine (using Bloodhound).

An example of such an attack would be abusing the MS-RPRN protocol which allows a domain user to remotely force a target host running the Print Spooler service to authenticate to an arbitrary IP address.

Requirements (besides machine account administrative privileges) for such an attack are:

* A valid set of AD account credentials
* Network connectivity to the target's SMB service
* The target host must be running the Print Spooler service
* The hosts must not have SMB signing enforced. This can be verified using `nmap` scripts such as:

```bash
$ nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
```

## Exploiting AD Users

In a compromised system, it would be a good idea to look around user directories to hunt for credentials.

If you have privileges as SYSTEM account, you can attempt to use a keylogger by migrating it to any running processes of a user (such as `explorer.exe`)so you can capture their input which might contain credentials. These credentials can be for different applications or services that are higher privilege than their own level of access.

## Exploiting GPOs

An example of exploiting GPOs would be adding an AD account to both the local Administrators and local Remote Desktop Users groups.

This attack requires access to Group Policy Management as the AD user that has relevant permissions.

## Exploiting Certificates

AD Certificate Services are Microsoft's Public Key Infrastructure (PKI) implementation.

Steps in exploiting certificates:

* Finding Vulnerable Certificate Templates (using the built-in tool `certutil`)
	* `certutil -Template -v > templates.txt`
* Exploiting a Certificate Template (using MMC to request a personal certificate)
* User Impersonation through a Certificate (use Rubeus with the certificate to request a Kerberos TGT, and load the TGT using Mimikatz to authenticate to the domain controller)
	* Rubeus: `Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate: /password: /outfile: /domain:za.tryhackme.loc /dc:`
	* mimikatz: `kerberos::ptt administrator.kirbi`

## Exploiting Domain Trusts

A forest = a collection of one or more domain trees inside an AD network. Trust largely refers to how the domains inside of a forest communicate with each other.

Trust can be configured between domains to be either: Directional or Transitive

### KRBTGT and Golden Tickets

KRBTGT (Kerberos - KRB and Ticket Granting Ticket - TGT) is the service account for the Kerberos Distribution Center (KDC), and handles all Kerberos ticket requests (as well as encrypt and sign all Kerberos tickets for the domain).

Golden Ticket Attacks = attacks that bypasses the KDC and creates its own TGTs, essentially becoming a Ticket Granting Server (TGS). For this type of attack, it is required to have:

* The FQDN of the domain
* The Security Identifier (SID) of the domain
* The username of the account we want to impersonate
* The KRBTGT password hash

While the first 3 items are easy to get, in order to obtain the KRBTGT password hash, a domain compromise is required. The KRBTGT password hash is only stored on domain controller. Example of recovering a KRBTGT password hash would be to use `Mimikatz` to perform a DC Sync attack.

### Inter-Realm TGTs

After getting the KRBTGT password hash, forging a Golden Ticket to access any resource in the child domain is easy. This can be taken a step further by forging an Inter-Realm TGT, which will be used to provide access to resources in other domains. This can be done by exploiting the bidirectional trust relationship between the child and parent domain to elevate to full access of the parent domain.

This is done by getting the SID of the Enterprise Admin (EA) group, in addition to the SID of the child domain controller.